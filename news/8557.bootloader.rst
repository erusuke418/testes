A major refactor and cleanup of bootloader's code.
